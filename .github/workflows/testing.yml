name: Pytest MSS

on:                                                                                  
  workflow_call:
    inputs:
      xdist:
        required: true
        type: string
      branch_name:
        required: true
        type: string
      event_name:
        required: true
        type: string
    secrets:
      PAT:
        required: true

env:
  PAT: ${{ secrets.PAT }}
  EVENT: ${{ inputs.event_name }}

jobs:
  Test-MSS:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    outputs:
      output1: ${{ steps.step1.outputs.triggerdockerbuild }}

    container:
      image: openmss/testing-${{ inputs.branch_name }}

    steps:
    - name: Trust My Directory
      run: git config --global --add safe.directory /__w/MSS/MSS

    - uses: actions/checkout@v3
    - name: Reinstall dependencies if changed
      id: step1
      run: |
        cmp -s /meta.yaml localbuild/meta.yaml && cmp -s /development.txt requirements.d/development.txt || (echo Dependencies differ \
        && echo "::set-output name=triggerdockerbuild::yes" \
        && cat localbuild/meta.yaml \
        | sed -n '/^requirements:/,/^test:/p' \
        | sed -e "s/.*- //" \
        | sed -e "s/menuinst.*//" \
        | sed -e "s/.*://" > reqs.txt \
        && conda deactivate \
        && conda deactivate \
        && conda env remove --name mssenv \
        && conda update -n base conda \
        && conda create -n mssenv mamba python=3.9.13 \
        && source /opt/conda/bin/activate mssenv \
        && mamba install pyvirtualdisplay python=3.9.13 \
        && mamba install --file reqs.txt \
        && mamba install --file requirements.d/development.txt)

    - name: Run tests
      if: ${{ always() && inputs.xdist == 'no' }}
      timeout-minutes: 25
      run: |
        source /opt/conda/bin/activate mssenv \
        && cd $GITHUB_WORKSPACE \
        && pytest -v --durations=20 --reverse --cov=mslib mslib \
        || (for i in {1..5} \
          ; do pytest mslib -v --durations=0 --reverse --last-failed --lfnf=none \
          && break \
        ; done)

    - name: Run tests in parallel
      if: ${{ always() && inputs.xdist == 'yes' }}
      timeout-minutes: 25
      run: |
        source /opt/conda/bin/activate mssenv \
        && cd $GITHUB_WORKSPACE \
        && pytest -vv -n 6 --dist loadfile --max-worker-restart 0 mslib \
        || (for i in {1..5} \
          ; do pytest -vv -n 6 --dist loadfile --max-worker-restart 0 mslib --last-failed --lfnf=none \
          && break \
        ; done)

    - name: Collect coverage
      if: ${{ always() && inputs.event_name == 'push' && inputs.branch_name == 'develop' && inputs.xdist == 'no'}}
      env: 
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        source /opt/conda/bin/activate mssenv \
        && cd $GITHUB_WORKSPACE \
        && mamba install coveralls \
        && coveralls --service=github


  Update-Images:
    runs-on: ubuntu-latest
    needs: Test-MSS
    
    steps:
      - if: ${{ env.PAT != '' && inputs.event_name == 'push' && needs.Test-MSS.step1.outputs.triggerdockerbuild == 'yes' && inputs.xdist == 'no'}}
        name: Invoke dockertesting image creation
        uses: benc-uk/workflow-dispatch@827565b908f387ffd483c84312273ae185c06c8a
        with:
          workflow: Update Image testing-${{ inputs.branch_name }}
          repo: Open-MSS/dockertesting
          ref: main
          token: ${{ secrets.PAT }}
